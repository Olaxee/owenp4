<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 Multi - Elo</title>
<style>
  body {
    background:#071128;
    color:white;
    font-family:sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    margin:0;
  }
  #auth, #game, #lobby {
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  input, button { padding:5px 10px; margin:5px; }
  #board {
    display:grid;
    grid-template-columns:repeat(7,50px);
    grid-template-rows:repeat(6,50px);
    gap:5px;
    margin-top:20px;
  }
  .cell {
    width:50px;
    height:50px;
    background:#333;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .player1 { background:red; }
  .player2 { background:yellow; }
  #elo {
    position:absolute;
    top:10px;
    right:20px;
    font-size:18px;
    color:#ffcc00;
  }
</style>
</head>
<body>

<div id="elo" style="display:none;">Elo : <span id="eloValue">1000</span></div>

<!-- Connexion -->
<div id="auth" style="display:flex;">
  <h2>Connexion / Inscription</h2>
  <input id="username" placeholder="Nom d'utilisateur"/>
  <input id="password" type="password" placeholder="Mot de passe"/>
  <button id="signup">S'inscrire</button>
  <button id="login">Se connecter</button>
</div>

<!-- Lobby -->
<div id="lobby" style="display:none;">
  <h2>Lobby</h2>
  <button id="createGame">Créer une partie</button>
  <input id="joinCode" placeholder="Code à rejoindre"/>
  <button id="joinGame">Rejoindre</button>
  <h3 id="showCode" style="display:none;">Code : <span id="gameCode"></span></h3>
</div>

<!-- Jeu -->
<div id="game" style="display:none;">
  <h2 id="status">En attente d'un adversaire...</h2>
  <div id="board"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://jyzcgwunvjjnhmjcrfim.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emNnd3VudmpqbmhtamNyZmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MzYzMDMsImV4cCI6MjA3NzUxMjMwM30.O8m8Uao-TTIWbHb65XIBkh7y5GAfTLjwWzFOTFizyYQ";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;
  let currentGame = null;
  let board = Array(42).fill(0);
  let gameOver = false;

  const authDiv = document.getElementById('auth');
  const lobbyDiv = document.getElementById('lobby');
  const gameDiv = document.getElementById('game');
  const boardDiv = document.getElementById('board');
  const statusH2 = document.getElementById('status');
  const showCode = document.getElementById('showCode');
  const gameCode = document.getElementById('gameCode');
  const eloDiv = document.getElementById('elo');
  const eloValue = document.getElementById('eloValue');

  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');

  // --- Auth ---
  document.getElementById('signup').onclick = async () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    if(!username || !password) return alert('Remplis tous les champs');
    const { error } = await supabaseClient.from('users').insert({ username, password, elo:1000 });
    if(error) return alert(error.message);
    alert('Inscription réussie ! Connectez-vous.');
  };

  document.getElementById('login').onclick = async () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    const { data, error } = await supabaseClient.from('users')
      .select()
      .eq('username', username)
      .eq('password', password)
      .maybeSingle();
    if(error || !data) return alert('Identifiants invalides');
    currentUser = data;
    authDiv.style.display = 'none';
    lobbyDiv.style.display = 'flex';
    eloDiv.style.display = 'block';
    eloValue.textContent = currentUser.elo ?? 1000;
  };

  // --- Lobby ---
  function generateCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  }

  document.getElementById('createGame').onclick = async () => {
    const code = generateCode();
    const { data, error } = await supabaseClient.from('games')
      .insert({ code, player1: currentUser.id, board: board.join(','), turn: 1, winner: null })
      .select()
      .maybeSingle();
    if(error) return alert(error.message);
    currentGame = data;
    showCode.style.display = 'block';
    gameCode.textContent = code;
    gameDiv.style.display = 'flex';
    boardDiv.style.display = 'none';
    statusH2.textContent = "En attente d'un adversaire...";
    pollGame();
  };

  document.getElementById('joinGame').onclick = async () => {
    const code = document.getElementById('joinCode').value.trim().toUpperCase();
    if(!code) return alert('Entre un code');
    const { data: game, error } = await supabaseClient.from('games').select().eq('code', code).maybeSingle();
    if(error || !game) return alert('Code invalide');
    if(game.player2) return alert('Partie déjà pleine');
    const { data, error:update } = await supabaseClient.from('games')
      .update({ player2: currentUser.id })
      .eq('id', game.id)
      .select()
      .maybeSingle();
    if(update) return alert(update.message);
    currentGame = data;
    lobbyDiv.style.display = 'none';
    gameDiv.style.display = 'flex';
    boardDiv.style.display = 'grid';
    statusH2.textContent = "C'est à votre adversaire de jouer";
    pollGame();
  };

  // --- Board ---
  function renderBoard() {
    boardDiv.innerHTML = '';
    board.forEach((cell, idx) => {
      const div = document.createElement('div');
      div.className = 'cell ' + (cell === 1 ? 'player1' : cell === 2 ? 'player2' : '');
      div.onclick = () => makeMove(idx % 7);
      boardDiv.appendChild(div);
    });
  }

  function checkWin(player) {
    const dirs = [1,7,6,8];
    for(let i=0;i<42;i++){
      if(board[i]!==player) continue;
      for(let d of dirs){
        if(board[i+d]===player && board[i+2*d]===player && board[i+3*d]===player)
          return true;
      }
    }
    return false;
  }

  async function makeMove(col) {
    if(!currentGame || gameOver) return;
    const turnPlayer = currentGame.turn === 1 ? currentGame.player1 : currentGame.player2;
    if(currentUser.id !== turnPlayer) return;
    for(let row = 5; row >= 0; row--) {
      const idx = row * 7 + col;
      if(board[idx] === 0) {
        board[idx] = currentGame.turn;
        break;
      }
    }

    if(checkWin(currentGame.turn)) {
      gameOver = true;
      await supabaseClient.from('games').update({ board: board.join(','), winner: currentUser.id }).eq('id', currentGame.id);
      await updateElo(currentGame.turn);
      statusH2.textContent = "Victoire !";
      return renderBoard();
    }

    const { data, error } = await supabaseClient.from('games')
      .update({ board: board.join(','), turn: currentGame.turn === 1 ? 2 : 1 })
      .eq('id', currentGame.id)
      .select()
      .maybeSingle();
    if(error) return alert(error.message);
    currentGame = data;
    renderBoard();
  }

  async function updateElo(winnerTurn) {
    const game = currentGame;
    const { data: p1 } = await supabaseClient.from('users').select().eq('id', game.player1).maybeSingle();
    const { data: p2 } = await supabaseClient.from('users').select().eq('id', game.player2).maybeSingle();
    if(!p1 || !p2) return;

    const K = 16;
    function expected(Ra, Rb){ return 1/(1+10**((Rb-Ra)/400)); }

    let Sa1=0.5, Sa2=0.5; // égalité
    if(winnerTurn===1){ Sa1=1; Sa2=0; }
    else if(winnerTurn===2){ Sa1=0; Sa2=1; }

    const R1new = Math.round(p1.elo + K * (Sa1 - expected(p1.elo, p2.elo)));
    const R2new = Math.round(p2.elo + K * (Sa2 - expected(p2.elo, p1.elo)));

    await supabaseClient.from('users').update({ elo:R1new }).eq('id', p1.id);
    await supabaseClient.from('users').update({ elo:R2new }).eq('id', p2.id);

    if(currentUser.id===p1.id) eloValue.textContent = R1new;
    if(currentUser.id===p2.id) eloValue.textContent = R2new;
  }

  async function pollGame() {
    if(!currentGame) return;
    const { data, error } = await supabaseClient.from('games').select().eq('id', currentGame.id).maybeSingle();
    if(error) return console.error(error);
    if(data) {
      currentGame = data;
      board = currentGame.board ? currentGame.board.split(',').map(Number) : Array(42).fill(0);
      const bothPlayers = currentGame.player1 && currentGame.player2;
      if(bothPlayers && !gameOver) {
        boardDiv.style.display = 'grid';
        if(currentGame.winner) {
          gameOver = true;
          statusH2.textContent = currentGame.winner === currentUser.id ? "Victoire !" : "Défaite...";
          await updateElo(currentGame.turn);
        } else {
          const yourTurn = (currentGame.turn === 1 && currentGame.player1 === currentUser.id) ||
                           (currentGame.turn === 2 && currentGame.player2 === currentUser.id);
          statusH2.textContent = yourTurn ? "Votre tour" : "Tour de votre adversaire";
        }
      }
      renderBoard();
    }
    setTimeout(pollGame, 2000);
  }
</script>

</body>
</html>