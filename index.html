<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 - Matchmaking</title>
<style>
body { background:#071128; color:white; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; }
#auth, #game { margin-top:20px; }
button { margin:5px; padding:10px; cursor:pointer; }
#grid { display:grid; grid-template-columns: repeat(7, 50px); grid-gap:5px; margin-top:20px; }
.cell { width:50px; height:50px; background:#0e1a2b; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; }
.cell.red { background:red; }
.cell.yellow { background:yellow; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Puissance 4 - Matchmaking</h1>

<div id="auth">
  <input type="text" id="username" placeholder="Nom d'utilisateur">
  <input type="password" id="password" placeholder="Mot de passe">
  <button id="btnRegister">S'inscrire</button>
  <button id="btnLogin">Se connecter</button>
</div>

<div id="game" style="display:none;">
  <button id="btnMatch">Trouver un adversaire</button>
  <div id="status"></div>
  <div id="grid"></div>
</div>

<script>
window.supabaseUrl = 'https://albdeswcrzcgwnlfcrvm.supabase.co';
window.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsYmRlc3djcnpjZ3dubGZjcnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MzI5NzgsImV4cCI6MjA3NzUwODk3OH0.IQqPKCsdexg0mNc4M3uQUgX3QbZXjI7UknyPwDzdSk0';
window.supabase = supabase.createClient(window.supabaseUrl, window.supabaseKey);

let currentUser = null;
let currentMatch = null;
let currentPlayerColor = 'red';
let gridState = Array(6).fill().map(()=>Array(7).fill(null));

// --- INSCRIPTION ---
function register(){
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  if(!username || !password){ alert('Remplissez tous les champs'); return; }

  window.supabase.from('users').insert([{ username, password, elo:1000 }])
  .then(({data, error})=>{
    if(error){ alert('Erreur: '+error.message); return; }
    alert('Inscription réussie ! Vous pouvez maintenant vous connecter.');
  });
}

// --- CONNEXION ---
function login(){
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  if(!username || !password){ alert('Remplissez tous les champs'); return; }

  window.supabase.from('users').select('*').eq('username', username).eq('password', password).limit(1)
  .then(({data, error})=>{
    if(error){ alert('Erreur: '+error.message); return; }
    if(data.length===0){ alert('Nom d\'utilisateur ou mot de passe incorrect'); return; }

    currentUser = data[0];
    document.getElementById('auth').style.display='none';
    document.getElementById('game').style.display='block';
    document.getElementById('status').innerText='Cliquez sur "Trouver un adversaire" pour commencer';
  });
}

// --- MATCHMAKING AVEC RETRY AUTOMATIQUE ---
async function startMatch(){
  document.getElementById('status').innerText='Recherche d\'adversaire...';

  try{
    let { data: waitingMatches } = await supabase
      .from('matches')
      .select('*')
      .eq('status','waiting')
      .limit(1);

    if(waitingMatches.length>0){
      const matchToJoin = waitingMatches[0];

      let { data, error } = await supabase
        .from('matches')
        .update({ player2: currentUser.id, status:'playing', turn: matchToJoin.player1 })
        .eq('id', matchToJoin.id)
        .eq('player2', null); // ✅ condition atomique

      if(error || data.length===0){
        // Réessayer automatiquement après 500ms
        setTimeout(startMatch, 500);
        return;
      }

      currentMatch = data[0];
      subscribeMatch(currentMatch.id);

    } else {
      // Créer un nouveau match
      const { data:newMatch, error:newErr } = await supabase
        .from('matches')
        .insert([{ player1: currentUser.id, status:'waiting', grid:gridState }])
        .select()
        .single();

      if(newErr){ alert('Erreur création match'); return; }

      currentMatch = newMatch;
      subscribeMatch(currentMatch.id);
    }

  } catch(err){
    console.log('Erreur matchmaking:', err);
    setTimeout(startMatch, 500);
  }
}

// --- SUBSCRIBE MATCH ---
function subscribeMatch(matchId){
  window.supabase.channel('public:matches')
  .on('postgres_changes',{event:'UPDATE',schema:'public',table:'matches',filter:`id=eq.${matchId}`},payload=>{
    const match = payload.new;
    currentMatch = match;
    gridState = match.grid;
    drawGrid();
    if(match.status==='playing'){
      if(match.turn === currentUser.id){
        document.getElementById('status').innerText="C'est votre tour";
      } else {
        document.getElementById('status').innerText="Tour de votre adversaire";
      }
    } else if(match.status==='finished'){
      document.getElementById('status').innerText="Match terminé. Cliquez sur 'Trouver un adversaire' pour rejouer.";
    }
  })
  .subscribe();
}

// --- DESSIN GRILLE ---
function drawGrid(){
  const grid = document.getElementById('grid');
  grid.innerHTML='';
  for(let r=0;r<6;r++){
    for(let c=0;c<7;c++){
      const cell = document.createElement('div');
      cell.className='cell';
      if(gridState[r][c]) cell.classList.add(gridState[r][c]);
      cell.dataset.row=r;
      cell.dataset.col=c;
      cell.onclick=()=>makeMove(c);
      grid.appendChild(cell);
    }
  }
}

// --- COUP ---
function makeMove(col){
  if(!currentMatch || currentMatch.status!=='playing') return;
  if(currentMatch.turn !== currentUser.id){ alert("Ce n'est pas votre tour"); return; }

  for(let r=5;r>=0;r--){
    if(!gridState[r][col]){
      gridState[r][col] = currentPlayerColor;
      drawGrid();

      if(checkWin(currentPlayerColor)){
        alert(currentPlayerColor==='red' ? 'Vous gagnez!' : 'Vous perdez!');
        updateElo(currentPlayerColor==='red');
        endMatch();
      } else {
        const nextTurn = currentUser.id===currentMatch.player1 ? currentMatch.player2 : currentMatch.player1;
        window.supabase.from('matches').update({grid:gridState, turn:nextTurn}).eq('id',currentMatch.id);
      }
      return;
    }
  }
}

// --- CHECK VICTOIRE ---
function checkWin(player){
  for(let r=0;r<6;r++){
    for(let c=0;c<7;c++){
      if(c+3<7 && gridState[r][c]===player && gridState[r][c+1]===player && gridState[r][c+2]===player && gridState[r][c+3]===player) return true;
      if(r+3<6 && gridState[r][c]===player && gridState[r+1][c]===player && gridState[r+2][c]===player && gridState[r+3][c]===player) return true;
      if(c+3<7 && r+3<6 && gridState[r][c]===player && gridState[r+1][c+1]===player && gridState[r+2][c+2]===player && gridState[r+3][c+3]===player) return true;
      if(c-3>=0 && r+3<6 && gridState[r][c]===player && gridState[r+1][c-1]===player && gridState[r+2][c-2]===player && gridState[r+3][c-3]===player) return true;
    }
  }
  return false;
}

// --- UPDATE ELO (simplifié pour l'instant) ---
function updateElo(won){
  console.log("Mettre à jour Elo ici si nécessaire");
}

// --- FIN DU MATCH ---
function endMatch(){
  if(currentMatch) window.supabase.from('matches').update({status:'finished'}).eq('id',currentMatch.id);
  currentMatch=null;
  gridState=Array(6).fill().map(()=>Array(7).fill(null));
  drawGrid();
  currentPlayerColor='red';
  document.getElementById('status').innerText='Match terminé. Cliquez sur "Trouver un adversaire" pour rejouer.';
}

// --- EVENTS ---
document.getElementById('btnRegister').onclick=register;
document.getElementById('btnLogin').onclick=login;
document.getElementById('btnMatch').onclick=startMatch;

</script>
</body>
</html>