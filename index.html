<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 - Elo Match</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body {
  background: #071128;
  color: white;
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
}
#auth, #lobby, #game { display: none; }
#grid { display: grid; grid-template-columns: repeat(7, 60px); grid-gap: 5px; margin-top: 20px; }
.cell { width: 60px; height: 60px; border-radius: 50%; background: #123; cursor: pointer; display: flex; justify-content: center; align-items: center; }
.cell.red { background: red; }
.cell.yellow { background: yellow; }
#eloDisplay { position: fixed; top: 10px; right: 20px; font-size: 18px; background: rgba(0,0,0,0.4); padding: 6px 10px; border-radius: 8px; }
</style>
</head>
<body>

<div id="eloDisplay"></div>

<div id="auth">
  <h2>Connexion / Inscription</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" placeholder="Mot de passe" type="password"><br><br>
  <button id="login">Connexion</button>
  <button id="signup">Inscription</button>
</div>

<div id="lobby">
  <h2 id="codeSection"></h2>
  <button id="createGame">Créer une partie (code aléatoire)</button>
  <input id="joinCode" placeholder="Entrer code à 6 lettres">
  <button id="joinGame">Rejoindre</button>
</div>

<div id="game">
  <h2 id="turnInfo"></h2>
  <div id="grid"></div>
</div>

<script>
const { createClient } = supabase;
const supabaseUrl = "https://jyzcgwunvjjnhmjcrfim.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emNnd3VudmpqbmhtamNyZmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MzYzMDMsImV4cCI6MjA3NzUxMjMwM30.O8m8Uao-TTIWbHb65XIBkh7y5GAfTLjwWzFOTFizyYQ";
const supabase = createClient(supabaseUrl, supabaseKey);

let user = null;
let currentGame = null;
let isMyTurn = false;
let playerColor = null;
let elo = 1000;

// --- Connexion / Inscription ---
document.getElementById("auth").style.display = "block";

document.getElementById("login").onclick = async () => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value,
  });
  if (error) return alert(error.message);
  user = data.user;
  await loadUserElo();
  showLobby();
};

document.getElementById("signup").onclick = async () => {
  const { data, error } = await supabase.auth.signUp({
    email: email.value,
    password: password.value,
  });
  if (error) return alert(error.message);
  await supabase.from("users").update({ elo: 1000 }).eq("id", data.user.id);
  user = data.user;
  await loadUserElo();
  showLobby();
};

// --- Charger Elo depuis Supabase ---
async function loadUserElo() {
  const { data, error } = await supabase.from("users").select("elo").eq("id", user.id).single();
  if (error) console.log(error);
  if (data?.elo) elo = data.elo;
  document.getElementById("eloDisplay").innerText = `Elo: ${elo}`;
}

// --- Sauvegarder Elo ---
async function saveUserElo(newElo) {
  elo = newElo;
  document.getElementById("eloDisplay").innerText = `Elo: ${Math.round(elo)}`;
  await supabase.from("users").update({ elo }).eq("id", user.id);
}

// --- Lobby ---
function showLobby() {
  document.getElementById("auth").style.display = "none";
  document.getElementById("lobby").style.display = "block";
}

document.getElementById("createGame").onclick = async () => {
  const code = Math.random().toString(36).substring(2, 8).toUpperCase();
  document.getElementById("codeSection").innerText = "Code de partie : " + code;
  const { data, error } = await supabase.from("games").insert({
    code, host: user.id, state: "waiting", board: JSON.stringify(Array(6).fill(Array(7).fill(null)))
  }).select().single();
  if (error) return alert(error.message);
  currentGame = data;
  playerColor = "red";
  watchGame(code);
};

document.getElementById("joinGame").onclick = async () => {
  const code = joinCode.value.trim().toUpperCase();
  const { data, error } = await supabase.from("games").update({
    guest: user.id, state: "playing"
  }).eq("code", code).select().single();
  if (error) return alert("Code invalide");
  currentGame = data;
  playerColor = "yellow";
  showGame();
};

// --- Game ---
function showGame() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("game").style.display = "block";
  renderGrid();
}

function renderGrid() {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  for (let i = 0; i < 6; i++) {
    for (let j = 0; j < 7; j++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.onclick = () => dropToken(j);
      grid.appendChild(cell);
    }
  }
}

async function dropToken(col) {
  if (!isMyTurn) return;
  isMyTurn = false;
  // logique jeu...
  // simulation fin
  const win = Math.random() > 0.5 ? "win" : "lose";
  await updateEloAfterMatch(win);
}

async function updateEloAfterMatch(result) {
  const { data } = await supabase.from("users").select("elo").eq("id", currentGame.host === user.id ? currentGame.guest : currentGame.host).single();
  const advElo = data?.elo ?? 1000;
  let S = result === "win" ? 1 : result === "lose" ? 0 : 0.5;
  const newElo = elo + 16 * (S - (1 / (1 + 10 ** ((advElo - elo) / 400))));
  await saveUserElo(newElo);
}

// --- Live updates ---
function watchGame(code) {
  const channel = supabase
    .channel("game_" + code)
    .on("postgres_changes", { event: "*", schema: "public", table: "games", filter: `code=eq.${code}` },
      payload => {
        const game = payload.new;
        if (game.state === "playing" && !document.getElementById("game").style.display.includes("block")) {
          currentGame = game;
          showGame();
        }
      }
    )
    .subscribe();
}
</script>
</body>
</html>