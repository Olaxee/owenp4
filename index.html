<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 P2P - Supabase</title>
<style>
/* === Styles comme avant (conserve ton design actuel) === */
:root{
  --bg:#071128; --card:#0e2436; --muted:#9fb7c7; --text:#e8f3fb;
  --accent:#2ea44f; --accent-strong:#26a14a; --ghost:#133147;
  --danger:#e06a4a; --glass: rgba(255,255,255,0.04);
  --board-hole:#0b3a57; --hole-edge:#163a54;
  --disc-shadow: rgba(0,0,0,0.45);
}
*{box-sizing:border-box} html,body{height:100%;}
body{margin:0;padding:0.9rem;font-family:-apple-system, "Inter", "Segoe UI", Roboto, sans-serif;
background: linear-gradient(180deg,var(--bg) 0%, #052033 100%); color:var(--text);
display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:0.8rem; min-height:100vh;}
h1{margin:0.6rem 0 0;font-size:1.15rem;font-weight:700;text-align:center;max-width:420px;text-shadow:0 1px 0 rgba(0,0,0,0.45);}
#loginContainer, #controls, #rematchContainer, #clocks, #playerInfo{width:100%; max-width:420px; display:flex; flex-direction:column; gap:0.45rem; padding:0.7rem; border-radius:12px; border:1px solid rgba(255,255,255,0.04); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); box-shadow:0 6px 18px rgba(2,6,12,0.55), inset 0 1px 0 rgba(255,255,255,0.02);}
input,textarea{width:100%; min-height:44px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); color:var(--text); font-size:0.95rem; outline:none; box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);}
button{display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:44px;padding:10px 14px;border-radius:12px;border:none;background:var(--ghost);color:var(--text);font-weight:700;font-size:0.95rem;cursor:pointer;transition: transform .08s ease, box-shadow .12s ease, background .12s ease; box-shadow:0 6px 14px rgba(2,6,12,0.5);}
#board{width:100%; max-width:420px; aspect-ratio:7/6; display:grid; grid-template-columns:repeat(7,1fr); grid-template-rows:repeat(6,1fr); gap:8px; padding:14px; border-radius:16px; background:linear-gradient(180deg,var(--board-hole), #082a3d); box-shadow:0 18px 40px rgba(1,8,15,0.7), inset 0 2px 10px rgba(255,255,255,0.02);}
.cell{width:100%; height:100%; border-radius:50%; display:flex; align-items:center; justify-content:center; background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.03), transparent 20%), linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); box-shadow: inset 0 -6px 12px rgba(0,0,0,0.6), inset 0 2px 6px rgba(255,255,255,0.02); cursor:pointer; position:relative; overflow:hidden; border:1px solid rgba(255,255,255,0.02);}
.disc{width:86%; height:86%; border-radius:50%; background:#111; box-shadow:0 6px 14px var(--disc-shadow), inset 0 2px 8px rgba(255,255,255,0.03);}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>
<body>
<h1>Puissance 4 P2P</h1>

<div id="loginContainer">
  <input id="usernameInput" placeholder="Pseudo">
  <input id="passwordInput" placeholder="Mot de passe">
  <button id="createAccountBtn">Créer un compte</button>
  <button id="loginBtn">Se connecter</button>
  <div id="loginStatus"></div>
</div>

<div id="playerInfo" style="display:none;">
  <div>Mon Elo : <span id="myElo"></span></div>
  <div id="opponentContainer" style="display:none;">Adversaire : <span id="opName">—</span> (<span id="opElo">—</span>)</div>
</div>

<div id="controls" style="display:none;">
  <button id="createOffer">Créer Offre</button>
  <button id="createAnswer" disabled>Créer Réponse</button>
  <textarea id="codeField" placeholder="Colle ou copie le code ici"></textarea><br>
  <button id="applyCode">Appliquer Code</button>
  <button id="copyCode">Copier Code</button>
  <div id="status">Statut : Déconnecté</div>
</div>

<div id="board"></div>

<script>
// === Supabase ===
const SUPABASE_URL = 'https://nowqsciorntrzvbaiuyv.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vd3FzY2lvcm50cnp2YmFpdXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTAwMzIsImV4cCI6MjA3NzMyNjAzMn0.Fze-O9qq5llDxbF4mRKV-JgaLvU3Z8N-O7VfUTNFrQQ';
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

let currentUser = null;

// === Auth / Profils ===
async function createAccount() {
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  if(!username||!password){ loginStatus.textContent='Pseudo et mdp requis'; return; }
  
  // Vérifier doublon
  const { data: existing } = await supabase.from('profiles').select().eq('username', username).single();
  if(existing){ loginStatus.textContent='Pseudo déjà utilisé'; return; }
  
  const { data, error } = await supabase.from('profiles').insert([{ username, password, elo:1000 }]).select().single();
  if(error){ loginStatus.textContent='Erreur: '+error.message; return; }
  loginStatus.textContent='Compte créé! Connectez-vous';
}

async function login() {
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  const { data, error } = await supabase.from('profiles').select().eq('username', username).eq('password', password).single();
  if(error){ loginStatus.textContent='Erreur: '+error.message; return; }
  currentUser = data;
  myElo.textContent = currentUser.elo;
  loginContainer.style.display='none';
  controls.style.display='flex';
  playerInfo.style.display='flex';
}

// === Evenements ===
createAccountBtn.onclick = createAccount;
loginBtn.onclick = login;

// === Plateau (simplifié pour démo) ===
const board = Array(6).fill().map(() => Array(7).fill(null));
const boardDiv = document.getElementById('board');

function renderBoard() {
  boardDiv.innerHTML = '';
  for (let r = 0; r < 6; r++) {
    for (let c = 0; c < 7; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.row = r;
      cell.dataset.col = c;
      if (board[r][c]) {
        const disc = document.createElement('div');
        disc.className = 'disc';
        disc.style.background = board[r][c] === 'red' ? 'red' : 'yellow';
        cell.appendChild(disc);
      }
      cell.addEventListener('click', () => playColumn(c));
      boardDiv.appendChild(cell);
    }
  }
}

let myTurn = true;
let myColor = 'red';
let peerConnection = null;
let dataChannel = null;

function playColumn(col) {
  if (!myTurn) return;
  for (let r = 5; r >= 0; r--) {
    if (!board[r][col]) {
      board[r][col] = myColor;
      renderBoard();
      myTurn = false;
      sendMove(r, col, myColor);
      checkWin(r, col, myColor);
      break;
    }
  }
}

// === Vérification victoire simple ===
function checkWin(row, col, color) {
  function countDir(dr, dc) {
    let r = row, c = col, count = 0;
    while (r >= 0 && r < 6 && c >= 0 && c < 7 && board[r][c] === color) {
      count++; r += dr; c += dc;
    }
    return count - 1;
  }
  const dirs = [[0,1],[1,0],[1,1],[1,-1]];
  for (let [dr, dc] of dirs) {
    if (countDir(dr, dc) + countDir(-dr, -dc) + 1 >= 4) {
      alert(color + ' a gagné !');
      return;
    }
  }
}

// === WebRTC P2P ===
async function createOffer() {
  peerConnection = new RTCPeerConnection();
  dataChannel = peerConnection.createDataChannel('game');
  setupDataChannel();
  
  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  codeField.value = JSON.stringify(offer);
  createAnswerBtn.disabled = false;
}

async function createAnswer() {
  peerConnection = new RTCPeerConnection();
  peerConnection.ondatachannel = (event) => {
    dataChannel = event.channel;
    setupDataChannel();
  };
  
  const offer = JSON.parse(codeField.value);
  await peerConnection.setRemoteDescription(offer);
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  codeField.value = JSON.stringify(answer);
}

async function applyCode() {
  if (!peerConnection) return;
  const code = JSON.parse(codeField.value);
  await peerConnection.setRemoteDescription(code);
}

function setupDataChannel() {
  dataChannel.onmessage = (event) => {
    const { r, c, color } = JSON.parse(event.data);
    board[r][c] = color;
    myTurn = true;
    renderBoard();
    checkWin(r, c, color);
  };
}

function sendMove(r, c, color) {
  if (dataChannel && dataChannel.readyState === 'open') {
    dataChannel.send(JSON.stringify({ r, c, color }));
  }
}

// === Evenements boutons ===
createOfferBtn.onclick = createOffer;
createAnswerBtn.onclick = createAnswer;
applyCodeBtn.onclick = applyCode;
copyCode.onclick = () => codeField.select() && document.execCommand('copy');

renderBoard();
</script>
</body>
</html>