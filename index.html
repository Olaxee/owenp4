<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 Matchmaking Stable</title>
<style>
:root{
  --bg:#071128; --card:#0e2436; --muted:#9fb7c7; --text:#e8f3fb;
  --accent:#2ea44f; --accent-strong:#26a14a; --ghost:#133147; --danger:#e06a4a;
  --board-hole:#0b3a57; --hole-edge:#163a54; --disc-shadow: rgba(0,0,0,0.45);
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; padding:0.9rem; font-family:-apple-system,"Inter","Segoe UI",Roboto,Arial,sans-serif;
background:linear-gradient(180deg,var(--bg) 0%,#052033 100%); color:var(--text);
display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:0.8rem;min-height:100vh;}
h1{margin:0.6rem 0 0;font-size:1.15rem;font-weight:700;color:var(--text);text-align:center;width:100%;max-width:420px;text-shadow:0 1px 0 rgba(0,0,0,0.45);padding:8px 0;}
#loginContainer,#controls,#rematchContainer,#clocks,#playerInfo{width:100%;max-width:420px;display:flex;flex-direction:column;gap:0.45rem;align-items:stretch;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));padding:0.7rem;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 6px 18px rgba(2,6,12,0.55), inset 0 1px 0 rgba(255,255,255,0.02);}
input,textarea{width:100%;min-height:44px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));color:var(--text);font-size:0.95rem;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);}
input::placeholder{color: rgba(255,255,255,0.35); font-weight:500;}
input:focus,textarea:focus{border-color: rgba(46,164,79,0.9);box-shadow:0 6px 18px rgba(46,164,79,0.06), inset 0 1px 0 rgba(255,255,255,0.02);}
button{display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:44px;padding:10px 14px;border-radius:12px;border:none;background:var(--ghost);color:var(--text);font-weight:700;font-size:0.95rem;cursor:pointer;transition: transform .08s ease, box-shadow .12s ease, background .12s ease;box-shadow:0 6px 14px rgba(2,6,12,0.5);}
#loginContainer button,#controls button,#rematchContainer button{background:linear-gradient(180deg,var(--accent),var(--accent-strong)); color:#fff;}
button:hover{ transform: translateY(-2px); } button:active{ transform: translateY(0); box-shadow:0 4px 8px rgba(0,0,0,0.5); } button:disabled{opacity:0.45;cursor:not-allowed;transform:none;box-shadow:none;}
#status,#loginStatus,#rematchStatus{color:var(--muted);font-weight:600;font-size:0.9rem;padding:6px 8px;border-radius:8px;background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.02);}
#playerInfo{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:8px;}
#playerInfo > div{display:flex;flex-direction:column;gap:4px;font-size:0.95rem;color:var(--text);}
#playerInfo span{ font-weight:800;color:#fff;font-size:0.95rem;}
#clocks{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.03);font-weight:800;font-size:0.95rem;}
#board{width:100%;max-width:420px;aspect-ratio:7/6;display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:repeat(6,1fr);gap:8px;padding:14px;border-radius:16px;background:linear-gradient(180deg,var(--board-hole),#082a3d);box-shadow:0 18px 40px rgba(1,8,15,0.7), inset 0 2px 10px rgba(255,255,255,0.02);}
.cell{width:100%;height:100%;aspect-ratio:1/1;border-radius:50%;display:flex;align-items:center;justify-content:center;background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.03), transparent 20%), linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));box-shadow: inset 0 -6px 12px rgba(0,0,0,0.6), inset 0 2px 6px rgba(255,255,255,0.02);cursor:pointer;position:relative;}
.disc{width:86%;height:86%;border-radius:50%;background:#111;box-shadow:0 6px 14px var(--disc-shadow), inset 0 2px 8px rgba(255,255,255,0.03);transition: transform .28s cubic-bezier(.2,.9,.3,1), background .2s ease, box-shadow .12s ease;}
.disc.red{background: linear-gradient(180deg,#ff5b5b,#c43b3b);}
.disc.yellow{background: linear-gradient(180deg,#ffd35b,#d6a42c);}
#rematchContainer{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;}
</style>
</head>
<body>
<h1>Puissance 4 Matchmaking</h1>

<div id="loginContainer">
  <input type="text" id="usernameInput" placeholder="Pseudo">
  <input type="password" id="passwordInput" placeholder="Mot de passe">
  <button id="createAccountBtn">Créer un compte</button>
  <button id="loginBtn">Se connecter</button>
  <div id="loginStatus"></div>
</div>

<div id="playerInfo" style="display:none;">
  <div id="myEloContainer">Elo : <span id="myElo"></span></div>
  <div id="opponentContainer" style="display:none;">Adversaire : <span id="opName">—</span> (<span id="opElo">—</span>)</div>
</div>

<div id="controls" style="display:none;">
  <button id="joinMatch">Chercher adversaire</button>
  <div id="status">Statut : Déconnecté</div>
</div>

<div id="clocks" style="display:none;">
  <div id="myClockContainer"><span id="myPseudo"></span> (<span id="myEloClock"></span>) : <span id="myClock">05:00</span></div>
  <div id="opClockContainer"><span id="opPseudo"></span> (<span id="opEloClock"></span>) : <span id="opClock">05:00</span></div>
</div>

<div id="board"></div>

<div id="rematchContainer">
  <button id="rematchBtn">Revanche</button>
  <button id="declineBtn">✖</button>
  <span id="rematchStatus"></span>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://arqyrmvnenrtxqryihnz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6...'; // ta key
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const el = id => document.getElementById(id);

let board = Array(6).fill().map(()=>Array(7).fill(''));
let currentUser = null;
let currentMatch = null;
let myColor = null, opponentColor = null;
let turn = null, gameOver=false;

// ---------- BOARD ----------
function createBoard(){
  const boardDiv = el('board');
  boardDiv.innerHTML='';
  for(let r=0;r<6;r++){
    for(let c=0;c<7;c++){
      const cell = document.createElement('div');
      cell.className='cell'; cell.dataset.col=c;
      const disc = document.createElement('div'); disc.className='disc';
      cell.appendChild(disc);
      cell.onclick = ()=> handleColumnClick(c);
      boardDiv.appendChild(cell);
    }
  }
}
function updateBoard(){
  const discs = document.querySelectorAll('.disc');
  for(let r=0;r<6;r++){
    for(let c=0;c<7;c++){
      const color = board[r][c];
      discs[r*7+c].style.background = color ? (color==='red' ? 'linear-gradient(180deg,#ff5b5b,#c43b3b)' : 'linear-gradient(180deg,#ffd35b,#d6a42c)') : '#111';
    }
  }
}
function handleColumnClick(col){
  if(gameOver || turn!==myColor) return;
  for(let r=5;r>=0;r--){
    if(!board[r][col]){
      board[r][col]=myColor;
      updateBoard();
      sendMove(col);
      switchTurn();
      checkWinCondition();
      return;
    }
  }
}
function checkWinCondition(){
  // version simplifiée, tu peux ajouter check 4 alignés
}

// ---------- LOGIN / CREATE ----------
el('createAccountBtn').onclick = async () => {
  const username = el('usernameInput').value.trim();
  const password = el('passwordInput').value.trim();
  if(!username || !password){ el('loginStatus').textContent="Pseudo et mdp requis"; return; }
  const { data, error } = await supabase.from('profiles').insert([{ username, password, elo:1000 }]);
  if(error){ el('loginStatus').textContent="Erreur création compte : "+error.message; return; }
  el('loginStatus').textContent="Compte créé, connecte-toi";
};
el('loginBtn').onclick = async () => {
  const username = el('usernameInput').value.trim();
  const password = el('passwordInput').value.trim();
  if(!username || !password){ el('loginStatus').textContent="Pseudo et mdp requis"; return; }
  const { data, error } = await supabase.from('profiles').select('*').eq('username',username).eq('password',password).single();
  if(error || !data){ el('loginStatus').textContent="Pseudo ou mdp incorrect"; return; }
  currentUser={username:data.username, elo:data.elo};
  el('myElo').textContent=currentUser.elo;
  el('loginContainer').style.display='none';
  el('controls').style.display='flex';
  el('playerInfo').style.display='flex';
  el('myPseudo').textContent=currentUser.username;
  el('myEloClock').textContent=currentUser.elo;
};

// ---------- MATCHMAKING ----------
el('joinMatch').onclick = async ()=>{
  setStatus("Recherche d'adversaire...");
  try {
    const { data: waiting, error } = await supabase.from('matches').select('*').eq('status','waiting').not('player1','eq',currentUser.username).limit(1).maybeSingle();
    if(error) console.log("Erreur select match:",error);

    if(!waiting){
      // CREATE match simple
      const { data, error } = await supabase.from('matches').insert([{
        player1: currentUser.username,
        status: 'waiting',
        p1_elo: currentUser.elo,
        boardstate: JSON.stringify(board),
        turn: 'red'
      }]).select();
      if(error){ console.log("Erreur insert match :", error); setStatus("Erreur création match"); return; }
      currentMatch = data[0];

      // écouter adversaire qui rejoint
      supabase.channel(`public:matches:id=eq.${currentMatch.id}`)
        .on('postgres_changes',{ event:'UPDATE', schema:'public', table:'matches', filter:`id=eq.${currentMatch.id}`},payload=>{
          if(payload.new.player2 && payload.new.player2!==currentUser.username){
            currentMatch=payload.new; opponentJoined();
          }
        }).subscribe();
    } else {
      // JOIN match existant
      const { data, error } = await supabase.from('matches').update({
        player2: currentUser.username,
        p2_elo: currentUser.elo,
        status: 'playing'
      }).eq('id',waiting.id).select();
      if(error){ console.log("Erreur update match :",error); return; }
      currentMatch=data[0];
      opponentJoined();
    }
  } catch(e){ console.log("Erreur matchmaking :", e); setStatus("Erreur matchmaking"); }
};

function opponentJoined(){
  myColor=currentMatch.player1===currentUser.username?'red':'yellow';
  opponentColor=myColor==='red'?'yellow':'red';
  turn='red';
  el('opName').textContent=currentMatch.player1===currentUser.username?currentMatch.player2:currentMatch.player1;
  el('opElo').textContent=currentMatch.player1===currentUser.username?currentMatch.p2_elo:currentMatch.p1_elo;
  el('opponentContainer').style.display='flex';
  el('clocks').style.display='flex';
  setStatus(turn===myColor?"À ton tour !":"Tour de l'autre joueur");
  if(currentMatch.boardstate){ board=JSON.parse(currentMatch.boardstate); updateBoard(); }
}

async function sendMove(col){
  if(!currentMatch) return;
  const { error } = await supabase.from('matches').update({
    boardstate: JSON.stringify(board),
    turn: (turn==='red'?'yellow':'red')
  }).eq('id',currentMatch.id);
  if(error) console.log("Erreur sendMove :",error);
}
function switchTurn(){ turn=(turn==='red'?'yellow':'red'); setStatus(turn===myColor?"À ton tour !":"Tour de l'autre joueur"); }
function setStatus(msg){ el('status').textContent="Statut : "+msg; }

createBoard();
updateBoard();
</script>
</body>
</html>