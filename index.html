<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 - Elo</title>
<style>
  body {
    background:#071128;
    color:white;
    font-family:sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    margin:0;
  }
  #auth, #game, #lobby {
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  input, button { padding:5px 10px; margin:5px; }
  #board {
    display:grid;
    grid-template-columns:repeat(7,50px);
    grid-template-rows:repeat(6,50px);
    gap:5px;
    margin-top:20px;
  }
  .cell {
    width:50px;
    height:50px;
    background:#333;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .player1 { background:red; }
  .player2 { background:yellow; }
  #eloDisplay {
    position:fixed;
    top:10px;
    right:20px;
    font-weight:bold;
    background:#0a1744;
    padding:8px 14px;
    border-radius:10px;
    box-shadow:0 0 5px rgba(255,255,255,0.2);
  }
</style>
</head>
<body>

<div id="eloDisplay" style="display:none;">Elo: 1000</div>

<!-- Connexion -->
<div id="auth" style="display:flex;">
  <h2>Connexion / Inscription</h2>
  <input id="username" placeholder="Nom d'utilisateur"/>
  <input id="password" type="password" placeholder="Mot de passe"/>
  <button id="signup">S'inscrire</button>
  <button id="login">Se connecter</button>
</div>

<!-- Lobby -->
<div id="lobby" style="display:none;">
  <h2>Lobby</h2>
  <button id="createGame">Créer une partie</button>
  <input id="joinCode" placeholder="Code à rejoindre"/>
  <button id="joinGame">Rejoindre</button>
  <h3 id="showCode" style="display:none;">Code : <span id="gameCode"></span></h3>
</div>

<!-- Jeu -->
<div id="game" style="display:none;">
  <h2 id="status">En attente d'un adversaire...</h2>
  <div id="board"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://jyzcgwunvjjnhmjcrfim.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emNnd3VudmpqbmhtamNyZmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MzYzMDMsImV4cCI6MjA3NzUxMjMwM30.O8m8Uao-TTIWbHb65XIBkh7y5GAfTLjwWzFOTFizyYQ";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;
  let currentGame = null;
  let board = Array(42).fill(0);

  const authDiv = document.getElementById('auth');
  const lobbyDiv = document.getElementById('lobby');
  const gameDiv = document.getElementById('game');
  const boardDiv = document.getElementById('board');
  const statusH2 = document.getElementById('status');
  const showCode = document.getElementById('showCode');
  const gameCode = document.getElementById('gameCode');
  const eloDisplay = document.getElementById('eloDisplay');

  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');

  // --- Auth ---
  document.getElementById('signup').onclick = async () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    if(!username || !password) return alert('Remplis tous les champs');
    const { error } = await supabaseClient.from('users').insert({ username, password, elo:1000 });
    if(error) return alert(error.message);
    alert('Inscription réussie ! Connectez-vous.');
  };

  document.getElementById('login').onclick = async () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    const { data, error } = await supabaseClient.from('users')
      .select()
      .eq('username', username)
      .eq('password', password)
      .maybeSingle();
    if(error || !data) return alert('Identifiants invalides');
    currentUser = data;
    updateEloDisplay(currentUser.elo);
    authDiv.style.display = 'none';
    lobbyDiv.style.display = 'flex';
  };

  function updateEloDisplay(elo) {
    eloDisplay.style.display = 'block';
    eloDisplay.textContent = `Elo: ${elo}`;
  }

  // --- Lobby ---
  function generateCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  }

  document.getElementById('createGame').onclick = async () => {
    const code = generateCode();
    const { data, error } = await supabaseClient.from('games')
      .insert({ code, player1: currentUser.id, board: board.join(','), turn: 1 })
      .select().maybeSingle();
    if(error) return alert(error.message);
    currentGame = data;
    showCode.style.display = 'block';
    gameCode.textContent = code;
    lobbyDiv.style.display = 'flex';
    gameDiv.style.display = 'flex';
    boardDiv.style.display = 'none';
    statusH2.textContent = "En attente d'un adversaire...";
    pollGame();
  };

  document.getElementById('joinGame').onclick = async () => {
    const code = document.getElementById('joinCode').value.trim().toUpperCase();
    if(!code) return alert('Entre un code');
    const { data: game, error } = await supabaseClient.from('games').select().eq('code', code).maybeSingle();
    if(error || !game) return alert('Code invalide');
    if(game.player2) return alert('Partie déjà pleine');
    const { data, error:update } = await supabaseClient.from('games')
      .update({ player2: currentUser.id })
      .eq('id', game.id)
      .select().maybeSingle();
    if(update) return alert(update.message);
    currentGame = data;
    lobbyDiv.style.display = 'none';
    gameDiv.style.display = 'flex';
    boardDiv.style.display = 'grid';
    statusH2.textContent = "C'est à votre adversaire de jouer";
    pollGame();
  };

  // --- Board ---
  function renderBoard() {
    boardDiv.innerHTML = '';
    board.forEach((cell, idx) => {
      const div = document.createElement('div');
      div.className = 'cell ' + (cell === 1 ? 'player1' : cell === 2 ? 'player2' : '');
      div.onclick = () => makeMove(idx % 7);
      boardDiv.appendChild(div);
    });
  }

  function checkWinner() {
    const lines = [];
    for(let r=0;r<6;r++)for(let c=0;c<7;c++){
      const idx=r*7+c;
      if(c<=3) lines.push([idx,idx+1,idx+2,idx+3]);
      if(r<=2) lines.push([idx,idx+7,idx+14,idx+21]);
      if(c<=3&&r<=2) lines.push([idx,idx+8,idx+16,idx+24]);
      if(c>=3&&r<=2) lines.push([idx,idx+6,idx+12,idx+18]);
    }
    for(const l of lines){
      const [a,b,c,d]=l;
      if(board[a]&&board[a]===board[b]&&board[a]===board[c]&&board[a]===board[d]) return board[a];
    }
    return board.every(v=>v!==0)?3:0;
  }

  async function makeMove(col) {
    if(!currentGame) return;
    const turnPlayer = currentGame.turn === 1 ? currentGame.player1 : currentGame.player2;
    if(currentUser.id !== turnPlayer) return;
    for(let row = 5; row >= 0; row--) {
      const idx = row * 7 + col;
      if(board[idx] === 0) {
        board[idx] = currentGame.turn;
        break;
      }
    }
    const winner = checkWinner();
    const nextTurn = currentGame.turn === 1 ? 2 : 1;

    let updateData = { board: board.join(','), turn: nextTurn };
    if(winner) updateData.winner = winner;

    const { data, error } = await supabaseClient.from('games')
      .update(updateData)
      .eq('id', currentGame.id)
      .select().maybeSingle();
    if(error) return alert(error.message);
    currentGame = data;
    renderBoard();
    if(winner) handleEndGame(winner);
  }

  async function handleEndGame(winner) {
    let resultMsg;
    if(winner === 3) resultMsg = "Égalité !";
    else resultMsg = (winner === 1 && currentUser.id === currentGame.player1) || (winner === 2 && currentUser.id === currentGame.player2)
      ? "Vous avez gagné !" : "Vous avez perdu...";

    statusH2.textContent = resultMsg;
    boardDiv.style.pointerEvents = 'none';

    if(winner === 3) return;

    const { data: player1 } = await supabaseClient.from('users').select().eq('id', currentGame.player1).maybeSingle();
    const { data: player2 } = await supabaseClient.from('users').select().eq('id', currentGame.player2).maybeSingle();

    const R1 = player1.elo, R2 = player2.elo;
    const S1 = (winner === 1 ? 1 : 0);
    const S2 = 1 - S1;

    const E1 = 1 / (1 + 10 ** ((R2 - R1)/400));
    const E2 = 1 / (1 + 10 ** ((R1 - R2)/400));

    const newR1 = Math.round(R1 + 16 * (S1 - E1));
    const newR2 = Math.round(R2 + 16 * (S2 - E2));

    await supabaseClient.from('users').update({ elo: newR1 }).eq('id', player1.id);
    await supabaseClient.from('users').update({ elo: newR2 }).eq('id', player2.id);

    if(currentUser.id === player1.id) updateEloDisplay(newR1);
    if(currentUser.id === player2.id) updateEloDisplay(newR2);
  }

  async function pollGame() {
    if(!currentGame) return;
    const { data, error } = await supabaseClient.from('games').select().eq('id', currentGame.id).maybeSingle();
    if(error) return console.error(error);
    if(data) {
      currentGame = data;
      board = currentGame.board ? currentGame.board.split(',').map(Number) : Array(42).fill(0);
      const bothPlayers = currentGame.player1 && currentGame.player2;
      if(bothPlayers) {
        boardDiv.style.display = 'grid';
        statusH2.textContent =
          (currentGame.turn === 1 && currentGame.player1 === currentUser.id) ||
          (currentGame.turn === 2 && currentGame.player2 === currentUser.id)
            ? "Votre tour"
            : "Tour de votre adversaire";
      }
      renderBoard();
      if(currentGame.winner) handleEndGame(currentGame.winner);
    }
    setTimeout(pollGame, 2000);
  }
</script>

</body>
</html>