<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 Multi - Elo</title>
<style>
  body {
    background:#071128;
    color:white;
    font-family:sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    margin:0;
  }
  #auth, #game, #lobby {
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  input, button { padding:5px 10px; margin:5px; }
  #board {
    display:grid;
    grid-template-columns:repeat(7,50px);
    grid-template-rows:repeat(6,50px);
    gap:5px;
    margin-top:20px;
  }
  .cell {
    width:50px;
    height:50px;
    background:#333;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .player1 { background:red; }
  .player2 { background:yellow; }
  #eloDisplay {
    position:fixed;
    top:10px;
    right:20px;
    font-weight:bold;
    color:#0f0;
  }
</style>
</head>
<body>

<div id="eloDisplay" style="display:none;">ELO: 1000</div>

<!-- Connexion -->
<div id="auth" style="display:flex;">
  <h2>Connexion / Inscription</h2>
  <input id="username" placeholder="Nom d'utilisateur"/>
  <input id="password" type="password" placeholder="Mot de passe"/>
  <button id="signup">S'inscrire</button>
  <button id="login">Se connecter</button>
</div>

<!-- Lobby -->
<div id="lobby" style="display:none;">
  <h2>Lobby</h2>
  <button id="createGame">Cr√©er une partie</button>
  <input id="joinCode" placeholder="Code √† rejoindre"/>
  <button id="joinGame">Rejoindre</button>
  <h3 id="showCode" style="display:none;">Code : <span id="gameCode"></span></h3>
</div>

<!-- Jeu -->
<div id="game" style="display:none;">
  <h2 id="status">En attente d'un adversaire...</h2>
  <div id="board"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://jyzcgwunvjjnhmjcrfim.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emNnd3VudmpqbmhtamNyZmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MzYzMDMsImV4cCI6MjA3NzUxMjMwM30.O8m8Uao-TTIWbHb65XIBkh7y5GAfTLjwWzFOTFizyYQ";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;
  let currentGame = null;
  let board = Array(42).fill(0);
  let gameEnded = false;

  const authDiv = document.getElementById('auth');
  const lobbyDiv = document.getElementById('lobby');
  const gameDiv = document.getElementById('game');
  const boardDiv = document.getElementById('board');
  const statusH2 = document.getElementById('status');
  const showCode = document.getElementById('showCode');
  const gameCode = document.getElementById('gameCode');
  const eloDisplay = document.getElementById('eloDisplay');

  // --- Auth ---
  document.getElementById('signup').onclick = async () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    if(!username || !password) return alert('Remplis tous les champs');
    const { error } = await supabaseClient.from('users').insert({ username, password, elo:1000 });
    if(error) return alert(error.message);
    alert('Inscription r√©ussie ! Connectez-vous.');
  };

  document.getElementById('login').onclick = async () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    const { data, error } = await supabaseClient.from('users')
      .select()
      .eq('username', username)
      .eq('password', password)
      .maybeSingle();
    if(error || !data) return alert('Identifiants invalides');
    currentUser = data;
    authDiv.style.display = 'none';
    lobbyDiv.style.display = 'flex';
    eloDisplay.style.display = 'block';
    updateEloDisplay();
  };

  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');

  function updateEloDisplay() {
    eloDisplay.textContent = `ELO: ${currentUser.elo ?? 1000}`;
  }

  // --- Lobby ---
  function generateCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  }

  document.getElementById('createGame').onclick = async () => {
    const code = generateCode();
    const { data, error } = await supabaseClient.from('games')
      .insert({ code, player1: currentUser.id, board: board.join(','), turn: 1, winner: null })
      .select()
      .maybeSingle();
    if(error) return alert(error.message);
    currentGame = data;
    showCode.style.display = 'block';
    gameCode.textContent = code;
    gameDiv.style.display = 'flex';
    boardDiv.style.display = 'none';
    statusH2.textContent = "En attente d'un adversaire...";
    pollGame();
  };

  document.getElementById('joinGame').onclick = async () => {
    const code = document.getElementById('joinCode').value.trim().toUpperCase();
    if(!code) return alert('Entre un code');
    const { data: game, error } = await supabaseClient.from('games').select().eq('code', code).maybeSingle();
    if(error || !game) return alert('Code invalide');
    if(game.player2) return alert('Partie d√©j√† pleine');
    const { data, error:update } = await supabaseClient.from('games')
      .update({ player2: currentUser.id })
      .eq('id', game.id)
      .select()
      .maybeSingle();
    if(update) return alert(update.message);
    currentGame = data;
    lobbyDiv.style.display = 'none';
    gameDiv.style.display = 'flex';
    boardDiv.style.display = 'grid';
    statusH2.textContent = "C'est √† votre adversaire de jouer";
    pollGame();
  };

  // --- Board ---
  function renderBoard() {
    boardDiv.innerHTML = '';
    board.forEach((cell, idx) => {
      const div = document.createElement('div');
      div.className = 'cell ' + (cell === 1 ? 'player1' : cell === 2 ? 'player2' : '');
      div.onclick = () => makeMove(idx % 7);
      boardDiv.appendChild(div);
    });
  }

  async function makeMove(col) {
    if(!currentGame || gameEnded) return;
    const turnPlayer = currentGame.turn === 1 ? currentGame.player1 : currentGame.player2;
    if(currentUser.id !== turnPlayer) return;
    for(let row = 5; row >= 0; row--) {
      const idx = row * 7 + col;
      if(board[idx] === 0) {
        board[idx] = currentGame.turn;
        break;
      }
    }

    const winner = checkWinner();
    const nextTurn = currentGame.turn === 1 ? 2 : 1;
    const { data, error } = await supabaseClient.from('games')
      .update({ board: board.join(','), turn: nextTurn, winner })
      .eq('id', currentGame.id)
      .select()
      .maybeSingle();
    if(error) return alert(error.message);
    currentGame = data;
    renderBoard();

    if(winner) {
      gameEnded = true;
      await updateElo(winner);
      alert(winner === (currentGame.player1 === currentUser.id ? 1 : 2) ? 'Vous avez gagn√© !' : 'Vous avez perdu.');
    }
  }

  function checkWinner() {
    const lines = [
      [1,0],[0,1],[1,1],[1,-1]
    ];
    for(let r=0;r<6;r++){
      for(let c=0;c<7;c++){
        const start = board[r*7+c];
        if(!start) continue;
        for(const [dr,dc] of lines){
          let count=1;
          for(let k=1;k<4;k++){
            const nr=r+dr*k,nc=c+dc*k;
            if(nr<0||nr>=6||nc<0||nc>=7) break;
            if(board[nr*7+nc]===start) count++;
            else break;
          }
          if(count>=4) return start;
        }
      }
    }
    return null;
  }

  async function updateElo(winnerNum) {
    const winnerId = winnerNum === 1 ? currentGame.player1 : currentGame.player2;
    const loserId = winnerNum === 1 ? currentGame.player2 : currentGame.player1;
    const { data: users } = await supabaseClient.from('users').select().in('id',[winnerId,loserId]);
    const winner = users.find(u=>u.id===winnerId);
    const loser = users.find(u=>u.id===loserId);

    const expectedWin = 1/(1+10**((loser.elo - winner.elo)/400));
    const expectedLose = 1/(1+10**((winner.elo - loser.elo)/400));

    const newWinnerElo = Math.round(winner.elo + 16*(1 - expectedWin));
    const newLoserElo = Math.round(loser.elo + 16*(0 - expectedLose));

    await supabaseClient.from('users').update({ elo:newWinnerElo }).eq('id',winner.id);
    await supabaseClient.from('users').update({ elo:newLoserElo }).eq('id',loser.id);

    if(currentUser.id===winner.id) currentUser.elo=newWinnerElo;
    if(currentUser.id===loser.id) currentUser.elo=newLoserElo;
    updateEloDisplay();
  }

  async function pollGame() {
    if(!currentGame) return;
    const { data, error } = await supabaseClient.from('games').select().eq('id', currentGame.id).maybeSingle();
    if(error) return console.error(error);
    if(data) {
      currentGame = data;
      board = currentGame.board ? currentGame.board.split(',').map(Number) : Array(42).fill(0);
      const bothPlayers = currentGame.player1 && currentGame.player2;
      if(bothPlayers) {
        boardDiv.style.display = 'grid';
        const yourTurn = (currentGame.turn === 1 && currentGame.player1 === currentUser.id) ||
                         (currentGame.turn === 2 && currentGame.player2 === currentUser.id);
        statusH2.textContent = currentGame.winner
          ? (currentGame.winner === (currentGame.player1 === currentUser.id ? 1 : 2)
              ? 'Vous avez gagn√© üéâ'
              : 'Vous avez perdu ‚ùå')
          : (yourTurn ? "Votre tour" : "Tour de votre adversaire");
      }
      renderBoard();
    }
    if(!currentGame.winner) setTimeout(pollGame, 2000);
  }
</script>

</body>
</html>