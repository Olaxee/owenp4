<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 - Elo Match</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body {
  background: #071128;
  color: white;
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
}
#auth, #lobby, #game { display: none; }
#grid {
  display: grid;
  grid-template-columns: repeat(7, 60px);
  grid-gap: 5px;
  margin-top: 20px;
}
.cell {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #123;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
}
.cell.red { background: red; }
.cell.yellow { background: yellow; }
#eloDisplay {
  position: fixed;
  top: 10px;
  right: 20px;
  font-size: 18px;
  background: rgba(0,0,0,0.4);
  padding: 6px 10px;
  border-radius: 8px;
}
</style>
</head>
<body>

<div id="eloDisplay">Elo : 1000</div>

<div id="auth">
  <h2>Connexion / Inscription</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" placeholder="Mot de passe" type="password"><br><br>
  <button id="login">Connexion</button>
  <button id="signup">Inscription</button>
</div>

<div id="lobby">
  <h2 id="codeSection"></h2>
  <button id="createGame">Créer une partie (code aléatoire)</button><br><br>
  <input id="joinCode" placeholder="Entrer code à 6 lettres">
  <button id="joinGame">Rejoindre</button>
</div>

<div id="game">
  <h2 id="turnInfo"></h2>
  <div id="grid"></div>
</div>

<script>
const { createClient } = supabase;
const supabaseUrl = "https://jyzcgwunvjjnhmjcrfim.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emNnd3VudmpqbmhtamNyZmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MzYzMDMsImV4cCI6MjA3NzUxMjMwM30.O8m8Uao-TTIWbHb65XIBkh7y5GAfTLjwWzFOTFizyYQ";
const supabaseClient = createClient(supabaseUrl, supabaseKey);

let user = null;
let currentGame = null;
let playerColor = null;
let elo = 1000;

// ------------------- AUTH -------------------
document.getElementById("auth").style.display = "block";

document.getElementById("login").onclick = async () => {
  const { data, error } = await supabaseClient.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) return alert(error.message);
  user = data.user;
  await ensureUserRow(user);
  await loadUserElo();
  showLobby();
};

document.getElementById("signup").onclick = async () => {
  const { data, error } = await supabaseClient.auth.signUp({
    email: email.value,
    password: password.value
  });
  if (error) return alert(error.message);
  user = data.user;
  await ensureUserRow(user);
  await loadUserElo();
  showLobby();
};

// ------------------- UTIL -------------------
async function ensureUserRow(user) {
  const { data } = await supabaseClient
    .from("users")
    .select("id, elo")
    .eq("id", user.id)
    .maybeSingle();

  if (!data) {
    await supabaseClient.from("users").insert({
      id: user.id,
      username: user.email,
      elo: 1000
    });
  }
}

async function loadUserElo() {
  const { data, error } = await supabaseClient
    .from("users")
    .select("elo")
    .eq("id", user.id)
    .single();
  if (error) console.error(error);
  if (data?.elo != null) elo = Number(data.elo);
  document.getElementById("eloDisplay").innerText = `Elo : ${elo}`;
}

async function saveUserElo(newElo) {
  elo = Math.round(newElo);
  document.getElementById("eloDisplay").innerText = `Elo : ${elo}`;
  const { error } = await supabaseClient
    .from("users")
    .update({ elo })
    .eq("id", user.id);
  if (error) console.error("Erreur update elo:", error);
}

// ------------------- LOBBY -------------------
function showLobby() {
  document.getElementById("auth").style.display = "none";
  document.getElementById("lobby").style.display = "block";
}

document.getElementById("createGame").onclick = async () => {
  const code = Math.random().toString(36).substring(2, 8).toUpperCase();
  document.getElementById("codeSection").innerText = "Code de partie : " + code;
  const emptyBoard = Array(6).fill(null).map(()=>Array(7).fill(null));
  const { data, error } = await supabaseClient.from("games").insert({
    code,
    host: user.id,
    state: "waiting",
    board: JSON.stringify(emptyBoard)
  }).select().single();
  if (error) return alert(error.message);
  currentGame = data;
  playerColor = "red";
  watchGame(code);
};

document.getElementById("joinGame").onclick = async () => {
  const code = joinCode.value.trim().toUpperCase();
  const { data, error } = await supabaseClient.from("games")
    .update({ guest: user.id, state: "playing" })
    .eq("code", code)
    .select()
    .single();
  if (error || !data) return alert("Code invalide ou partie inexistante");
  currentGame = data;
  playerColor = "yellow";
  showGame();
};

// ------------------- GAME -------------------
function showGame() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("game").style.display = "block";
  renderGrid();
  document.getElementById("turnInfo").innerText = "La partie commence !";
}

function renderGrid() {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  for (let i = 0; i < 6; i++) {
    for (let j = 0; j < 7; j++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.onclick = () => playTurn(j);
      grid.appendChild(cell);
    }
  }
}

async function playTurn(col) {
  // Pour test : simulateur win/lose aléatoire
  const result = Math.random() > 0.5 ? "win" : "lose";
  await updateEloAfterMatch(result);
}

async function updateEloAfterMatch(result) {
  const advId = (currentGame.host === user.id) ? currentGame.guest : currentGame.host;
  const { data: advData, error: advError } = await supabaseClient
    .from("users")
    .select("elo")
    .eq("id", advId)
    .single();
  if (advError || !advData) return console.error("Erreur get adv elo:", advError);

  const advElo = Number(advData.elo);
  const S = result === "win" ? 1 : result === "lose" ? 0 : 0.5;
  const newElo = Number(elo) + 16 * (S - (1 / (1 + 10 ** ((advElo - Number(elo)) / 400))));
  await saveUserElo(newElo);

  document.getElementById("turnInfo").innerText =
    `Résultat : ${result.toUpperCase()} — Nouveau Elo : ${Math.round(newElo)}`;
}

// ------------------- LIVE -------------------
function watchGame(code) {
  const channel = supabaseClient
    .channel("game_" + code)
    .on("postgres_changes", {
      event: "*",
      schema: "public",
      table: "games",
      filter: `code=eq.${code}`
    }, payload => {
      const game = payload.new;
      if (game.state === "playing" && document.getElementById("game").style.display === "none") {
        currentGame = game;
        showGame();
      }
    })
    .subscribe();
}
</script>
</body>
</html>