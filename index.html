
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 Multi</title>
<style>
  body {
    background:#071128;
    color:white;
    font-family:sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    margin:0;
  }
  #auth, #game, #lobby {
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  input, button { padding:5px 10px; margin:5px; }
  #board {
    display:grid;
    grid-template-columns:repeat(7,50px);
    grid-template-rows:repeat(6,50px);
    gap:5px;
    margin-top:20px;
  }
  .cell {
    width:50px;
    height:50px;
    background:#333;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    cursor:pointer;
  }
  .player1 { background:red; }
  .player2 { background:yellow; }
</style>
</head>
<body>

<div id="auth" style="display:flex;">
  <h2>Connexion / Inscription</h2>
  <input id="username" placeholder="Nom d'utilisateur"/>
  <input id="password" type="password" placeholder="Mot de passe"/>
  <button id="signup">S'inscrire</button>
  <button id="login">Se connecter</button>
</div>

<div id="lobby" style="display:none;">
  <h2>Lobby</h2>
  <button id="createGame">Créer une partie</button>
  <input id="joinCode" placeholder="Code à rejoindre"/>
  <button id="joinGame">Rejoindre la partie</button>
</div>

<div id="game" style="display:none;">
  <h2 id="status">En attente...</h2>
  <div id="board"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "TON_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "TON_SUPABASE_ANON_KEY";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;
  let currentGame = null;
  let board = Array(42).fill(0);

  const authDiv = document.getElementById('auth');
  const lobbyDiv = document.getElementById('lobby');
  const gameDiv = document.getElementById('game');
  const boardDiv = document.getElementById('board');
  const statusH2 = document.getElementById('status');

  // --- Auth ---
  document.getElementById('signup').onclick = async () => {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    if(!username || !password) return alert('Remplis tous les champs');
    const { data, error } = await supabase.from('users').insert({ username, password });
    if(error) return alert(error.message);
    alert('Inscription réussie ! Connectez-vous.');
  };

  document.getElementById('login').onclick = async () => {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    if(!username || !password) return alert('Remplis tous les champs');
    const { data, error } = await supabase.from('users').select().eq('username', username).eq('password', password).maybeSingle();
    if(error || !data) return alert('Identifiants invalides');
    currentUser = data;
    authDiv.style.display = 'none';
    lobbyDiv.style.display = 'flex';
  };

  // --- Lobby ---
  function generateCode() {
    return Math.random().toString(36).substring(2,8).toUpperCase();
  }

  document.getElementById('createGame').onclick = async () => {
    const code = generateCode();
    const { data, error } = await supabase.from('games').insert({
      code,
      player1: currentUser.id
    }).select().maybeSingle();
    if(error) return alert(error.message);
    currentGame = data;
    lobbyDiv.style.display = 'none';
    gameDiv.style.display = 'flex';
    statusH2.textContent = 'En attente d\'un adversaire...';
    pollGame();
    alert('Code pour rejoindre : ' + code);
  };

  document.getElementById('joinGame').onclick = async () => {
    const code = document.getElementById('joinCode').value.toUpperCase();
    if(!code) return alert('Entre un code');
    const { data: game, error } = await supabase.from('games').select().eq('code', code).maybeSingle();
    if(error || !game) return alert('Code invalide');
    if(game.player2) return alert('Partie déjà complète');
    const { data, error:update } = await supabase.from('games').update({ player2: currentUser.id }).eq('id', game.id).select().maybeSingle();
    if(update) return alert(update.message);
    currentGame = data;
    lobbyDiv.style.display = 'none';
    gameDiv.style.display = 'flex';
    pollGame();
  };

  // --- Board ---
  function renderBoard() {
    boardDiv.innerHTML = '';
    board.forEach((cell, idx) => {
      const div = document.createElement('div');
      div.className = 'cell ' + (cell === 1 ? 'player1' : cell === 2 ? 'player2' : '');
      div.onclick = () => makeMove(idx % 7);
      boardDiv.appendChild(div);
    });
  }

  async function makeMove(col) {
    if(!currentGame) return;
    const turnPlayer = currentGame.turn === 1 ? currentGame.player1 : currentGame.player2;
    if(currentUser.id !== turnPlayer) return alert('Ce n\'est pas votre tour !');

    for(let row=5; row>=0; row--) {
      const idx = row*7 + col;
      if(board[idx] === 0) {
        board[idx] = currentGame.turn;
        break;
      }
    }

    const { data, error } = await supabase.from('games').update({
      board: board.join(','),
      turn: currentGame.turn === 1 ? 2 : 1
    }).eq('id', currentGame.id).select().maybeSingle();
    if(error) return alert(error.message);
    currentGame = data;
    renderBoard();
  }

  async function pollGame() {
    if(!currentGame) return;
    const { data, error } = await supabase.from('games').select().eq('id', currentGame.id).maybeSingle();
    if(error) return console.error(error);
    if(data) {
      currentGame = data;
      board = currentGame.board.split(',').map(Number);
      renderBoard();
      const yourTurn = (currentGame.turn === 1 && currentGame.player1 === currentUser.id) ||
                       (currentGame.turn === 2 && currentGame.player2 === currentUser.id);
      statusH2.textContent = yourTurn ? 'Votre tour' : 'Tour de votre adversaire';
    }
    setTimeout(pollGame, 2000);
  }
</script>

</body>
</html>