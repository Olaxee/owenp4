<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 Matchmaking & Elo</title>
<style>
body { background:#071128; color:white; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; }
#login, #game { margin-top:20px; }
#grid { display:grid; grid-template-columns: repeat(7, 50px); grid-gap:5px; margin-top:20px; }
.cell { width:50px; height:50px; background:#0e1a2b; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; }
.cell.red { background:red; }
.cell.yellow { background:yellow; }
button { margin:5px; padding:10px; cursor:pointer; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Puissance 4 - Matchmaking & Elo</h1>

<div id="login">
  <input type="text" id="username" placeholder="Nom d'utilisateur">
  <input type="password" id="password" placeholder="Mot de passe">
  <button onclick="login()">Se connecter</button>
</div>

<div id="game" style="display:none;">
  <button onclick="startMatch()">Trouver un adversaire</button>
  <div id="status"></div>
  <div id="grid"></div>
</div>

<script>
const supabaseUrl = 'TON_SUPABASE_URL';
const supabaseKey = 'TON_SUPABASE_ANON_KEY';
const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

let currentUser, opponentUser, currentPlayer = 'red', gridState = Array(6).fill().map(()=>Array(7).fill(null));

// Login function
async function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  let { data, error } = await supabase.from('users').select('*').eq('username', username).eq('password', password).limit(1);
  if(data.length === 0){
    alert('Utilisateur inconnu ou mot de passe incorrect.');
    return;
  }
  currentUser = data[0];
  document.getElementById('login').style.display = 'none';
  document.getElementById('game').style.display = 'block';
}

// Start matchmaking
async function startMatch() {
  document.getElementById('status').innerText = 'Recherche d\'adversaire...';
  // Récupérer un joueur avec Elo proche
  let { data: potential, error } = await supabase.from('users').select('*').neq('id', currentUser.id).order('elo', { ascending:true }).limit(1);
  if(potential.length === 0){
    alert('Pas d\'adversaire disponible.');
    return;
  }
  opponentUser = potential[0];
  document.getElementById('status').innerText = `Vous jouez contre ${opponentUser.username} (Elo: ${opponentUser.elo})`;
  drawGrid();
}

// Draw grid
function drawGrid(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  for(let r=0;r<6;r++){
    for(let c=0;c<7;c++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      if(gridState[r][c]) cell.classList.add(gridState[r][c]);
      cell.dataset.row = r;
      cell.dataset.col = c;
      cell.onclick = () => makeMove(c);
      grid.appendChild(cell);
    }
  }
}

// Make move
function makeMove(col){
  for(let r=5;r>=0;r--){
    if(!gridState[r][col]){
      gridState[r][col] = currentPlayer;
      drawGrid();
      if(checkWin(currentPlayer)){
        alert(currentPlayer === 'red' ? 'Vous gagnez!' : 'Vous perdez!');
        updateElo(currentPlayer==='red');
        resetGame();
      }
      currentPlayer = currentPlayer === 'red' ? 'yellow' : 'red';
      return;
    }
  }
}

// Check win
function checkWin(player){
  // Horizontal, vertical, diagonals
  for(let r=0;r<6;r++){
    for(let c=0;c<7;c++){
      if(c+3<7 && gridState[r][c]===player && gridState[r][c+1]===player && gridState[r][c+2]===player && gridState[r][c+3]===player) return true;
      if(r+3<6 && gridState[r][c]===player && gridState[r+1][c]===player && gridState[r+2][c]===player && gridState[r+3][c]===player) return true;
      if(c+3<7 && r+3<6 && gridState[r][c]===player && gridState[r+1][c+1]===player && gridState[r+2][c+2]===player && gridState[r+3][c+3]===player) return true;
      if(c-3>=0 && r+3<6 && gridState[r][c]===player && gridState[r+1][c-1]===player && gridState[r+2][c-2]===player && gridState[r+3][c-3]===player) return true;
    }
  }
  return false;
}

// Update Elo
async function updateElo(won){
  const S = won ? 1 : 0;
  const Ryou = currentUser.elo;
  const Radv = opponentUser.elo;
  const Rnew = Ryou + 16*(S - 1/(1 + 10**((Radv-Ryou)/400)));
  await supabase.from('users').update({ elo: Math.round(Rnew) }).eq('id', currentUser.id);
}

// Reset game
function resetGame(){
  gridState = Array(6).fill().map(()=>Array(7).fill(null));
  drawGrid();
  currentPlayer = 'red';
  document.getElementById('status').innerText = 'Cliquez sur "Trouver un adversaire" pour rejouer.';
}
</script>

</body>
</html>