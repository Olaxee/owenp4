<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Puissance 4 avec ELO</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      background: #0a1020;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    #auth, #game { display: none; margin-top: 50px; }
    input { margin: 5px; padding: 8px; border-radius: 5px; border: none; }
    button { margin: 5px; padding: 8px 16px; border: none; border-radius: 5px; background: #1976d2; color: white; cursor: pointer; }
    button:hover { background: #1565c0; }
    table { margin: 20px auto; border-collapse: collapse; }
    td {
      width: 60px; height: 60px; background: #112; border-radius: 50%;
      border: 2px solid #223;
    }
    .R { background: red; }
    .Y { background: yellow; }
    #elo {
      position: absolute;
      top: 10px;
      right: 20px;
      font-weight: bold;
      background: rgba(0,0,0,0.4);
      padding: 8px 12px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h1>Puissance 4</h1>
  <div id="elo">ELO: 1000</div>

  <div id="auth">
    <h2>Connexion / Inscription</h2>
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Mot de passe"><br>
    <button id="signup">Inscription</button>
    <button id="login">Connexion</button>
  </div>

  <div id="game">
    <div id="status"></div>
    <div id="code-section">
      <button id="create">CrÃ©er un code</button>
      <input id="joinCode" maxlength="6" placeholder="Entrer code Ã  6 caractÃ¨res">
      <button id="join">Rejoindre</button>
      <p id="showCode"></p>
    </div>
    <table id="grid"></table>
  </div>

  <script>
    const SUPABASE_URL = "https://jyzcgwunvjjnhmjcrfim.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emNnd3VudmpqbmhtamNyZmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MzYzMDMsImV4cCI6MjA3NzUxMjMwM30.O8m8Uao-TTIWbHb65XIBkh7y5GAfTLjwWzFOTFizyYQ";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const authDiv = document.getElementById("auth");
    const gameDiv = document.getElementById("game");
    const grid = document.getElementById("grid");
    const status = document.getElementById("status");
    const eloDisplay = document.getElementById("elo");

    let sessionUser = null;
    let currentGame = null;
    let playerColor = null;
    let gameCode = null;

    // === Connexion / Inscription ===
    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        sessionUser = user;
        await showGame();
      } else {
        authDiv.style.display = "block";
      }
    }

    document.getElementById("signup").onclick = async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) alert(error.message); else alert("Compte crÃ©Ã© !");
    };

    document.getElementById("login").onclick = async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert(error.message); else location.reload();
    };

    async function showGame() {
      authDiv.style.display = "none";
      gameDiv.style.display = "block";
      await updateEloDisplay();
    }

    async function updateEloDisplay() {
      const { data } = await supabase.from("users").select("elo").eq("id", sessionUser.id).single();
      if (data) eloDisplay.innerText = "ELO: " + data.elo;
    }

    // === Code de partie ===
    document.getElementById("create").onclick = async () => {
      gameCode = Math.random().toString(36).substring(2, 8).toUpperCase();
      document.getElementById("showCode").innerText = "Code: " + gameCode;

      await supabase.from("games").insert({
        code: gameCode,
        player1: sessionUser.id,
        state: JSON.stringify(Array(6).fill().map(()=>Array(7).fill(null))),
        turn: "R"
      });
      playerColor = "R";
      status.innerText = "En attente dâ€™un adversaire...";
      listenGame();
    };

    document.getElementById("join").onclick = async () => {
      const inputCode = document.getElementById("joinCode").value.toUpperCase();
      const { data: game } = await supabase.from("games").select("*").eq("code", inputCode).single();
      if (!game) return alert("Code invalide !");
      await supabase.from("games").update({ player2: sessionUser.id }).eq("code", inputCode);
      playerColor = "Y";
      gameCode = inputCode;
      listenGame();
    };

    // === Ã‰coute en temps rÃ©el ===
    function listenGame() {
      supabase.channel("game-" + gameCode)
        .on("postgres_changes", { event: "*", schema: "public", table: "games", filter: `code=eq.${gameCode}` },
          payload => {
            currentGame = payload.new;
            renderGrid(JSON.parse(currentGame.state));
            if (currentGame.winner) {
              handleWinner(currentGame.winner);
            }
          })
        .subscribe();

      loadGame();
    }

    async function loadGame() {
      const { data } = await supabase.from("games").select("*").eq("code", gameCode).single();
      if (data) {
        currentGame = data;
        renderGrid(JSON.parse(data.state));
      }
    }

    // === Grille ===
    function renderGrid(state) {
      grid.innerHTML = "";
      state.forEach((row, i) => {
        const tr = document.createElement("tr");
        row.forEach((cell, j) => {
          const td = document.createElement("td");
          if (cell) td.classList.add(cell);
          td.onclick = () => playMove(j);
          tr.appendChild(td);
        });
        grid.appendChild(tr);
      });
    }

    async function playMove(col) {
      if (!currentGame || currentGame.winner) return;
      const board = JSON.parse(currentGame.state);
      for (let i = 5; i >= 0; i--) {
        if (!board[i][col]) {
          board[i][col] = playerColor;
          break;
        }
      }

      if (checkWinner(board, playerColor)) {
        await supabase.from("games").update({
          state: JSON.stringify(board),
          winner: playerColor
        }).eq("code", gameCode);
      } else {
        await supabase.from("games").update({
          state: JSON.stringify(board),
          turn: playerColor === "R" ? "Y" : "R"
        }).eq("code", gameCode);
      }
    }

    function checkWinner(b, c) {
      for (let i=0;i<6;i++) for (let j=0;j<7;j++) {
        if (j+3<7 && b[i][j]==c && b[i][j+1]==c && b[i][j+2]==c && b[i][j+3]==c) return true;
        if (i+3<6 && b[i][j]==c && b[i+1][j]==c && b[i+2][j]==c && b[i+3][j]==c) return true;
        if (i+3<6 && j+3<7 && b[i][j]==c && b[i+1][j+1]==c && b[i+2][j+2]==c && b[i+3][j+3]==c) return true;
        if (i+3<6 && j-3>=0 && b[i][j]==c && b[i+1][j-1]==c && b[i+2][j-2]==c && b[i+3][j-3]==c) return true;
      }
      return false;
    }

    async function handleWinner(color) {
      status.innerText = color === playerColor ? "ðŸŽ‰ Vous avez gagnÃ© !" : "ðŸ˜¢ Vous avez perdu...";

      // RÃ©cupÃ¨re les 2 joueurs
      const { data: game } = await supabase.from("games").select("*").eq("code", gameCode).single();
      const { data: p1 } = await supabase.from("users").select("id, elo").eq("id", game.player1).single();
      const { data: p2 } = await supabase.from("users").select("id, elo").eq("id", game.player2).single();
      if (!p1 || !p2) return;

      const K = 16;
      const expected1 = 1 / (1 + 10 ** ((p2.elo - p1.elo) / 400));
      const expected2 = 1 / (1 + 10 ** ((p1.elo - p2.elo) / 400));
      const S1 = color === "R" ? 1 : 0;
      const S2 = color === "Y" ? 1 : 0;

      const newElo1 = Math.round(p1.elo + K * (S1 - expected1));
      const newElo2 = Math.round(p2.elo + K * (S2 - expected2));

      await supabase.from("users").update({ elo: newElo1 }).eq("id", p1.id);
      await supabase.from("users").update({ elo: newElo2 }).eq("id", p2.id);
      await updateEloDisplay();
    }

    init();
  </script>
</body>
</html>